<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>فورمة التاجير — تاريخ/وقت تلقائي (توقيت بغداد)</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <style>
  :root{
    --bg:#0b1020; --card:#101833; --card-2:#0f1839; --text:#e9eefb; --muted:#aab4d6; --accent:#8ab4ff;
    --ok:#70d28f; --bad:#ef767a; --border:#243165; --ring:#6ea8ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(160deg,#0b1020 0%,#0a132d 100%);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial}
  header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:rgba(11,16,32,.82);backdrop-filter:blur(10px);z-index:20}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .container{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.28);padding:16px}
  label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
  input,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0e1631;color:#e9eefb;outline:none;transition:.18s ease}
  input::placeholder{color:#8ea1d0}
  input:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(110,168,255,.18)}
  input[readonly], input:disabled{opacity:.95;cursor:not-allowed;background:#0f1838}
  button{cursor:pointer;background:linear-gradient(180deg,#1a2a74,#13215a);border:1px solid #31428a}
  button:hover{filter:brightness(1.05);transform:translateY(-1px)}
  button:active{transform:translateY(0)}
  .grid{display:grid;gap:12px}
  .form-grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:980px){.form-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:620px){.form-grid{grid-template-columns:1fr}}

  .field{position:relative;background:var(--card-2);border:1px solid var(--border);border-radius:14px;padding:10px}
  .field input{background:#0e1736;border-color:#2a366b}

  table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
  thead th{position:sticky;top:0;background:#0f1a39;padding:10px;border:1px solid var(--border);font-size:12px;color:#aab4d6;backdrop-filter:blur(6px)}
  tbody td{background:#0f1838;border:1px solid #243165;padding:10px;font-size:13px}
  tbody tr:hover td{background:#11204a}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btnbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#0f1a39;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#aab4d6}
  .hl{color:var(--accent)}

  .warn,.ok{padding:10px 12px;border-radius:12px;font-size:12px;display:none}
  .warn{background:#331a1a;border:1px solid #5a3333;color:#ffb4b4}
  .ok{background:#0f2a1b;border:1px solid #2f6845;color:#a7f5bd}
  .note{font-size:12px;color:#aab4d6}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f1a39;border:1px solid var(--border);border-radius:6px;padding:2px 6px}

  /* أزرار الموقع/الكاميرا بحجم صغير */
  .geo-btn{position:absolute;inset-inline-end:10px;top:34px;font-size:10px;padding:3px 6px;border-radius:8px;background:#0e2a64;color:#c7d6ff;border:1px solid #355aa4}
  .cam-btn{position:absolute;inset-inline-end:36px;top:34px;font-size:9px;padding:2px 4px;border-radius:6px;background:#274416;color:#d8f3c7;border:1px solid #3f6d23}

  .thumb{display:inline-block;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .thumb img{display:block;max-width:70px;max-height:50px}

  /* معاينة الكاميرا (مودال خفيف) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
  .modal-card{position:relative;background:#0f1839;border:1px solid #243165;border-radius:16px;padding:12px;z-index:51;width:min(92vw,520px)}
  .modal video{width:100%;border-radius:12px;background:#000}
  .modal .actions{display:flex;gap:8px;justify-content:space-between;margin-top:10px}
  .modal .actions button{width:auto}
  </style>
</head>
<body>
  <header><h1>فورمة التاجير — تاريخ/وقت تلقائي (توقيت بغداد)</h1></header>
  <div class="container">
    <div class="card grid">
      <div id="msgOk" class="ok"></div>
      <div id="msgWarn" class="warn"></div>

      <div class="note">حقل <b>التاريخ</b> يُملأ تلقائيًا بتوقيت <b>Asia/Baghdad</b> ويظهر للعرض فقط.</div>
      <div class="note">اختصارات: <span class="kbd">Enter</span> = إضافة صف، <span class="kbd">Ctrl + S</span> = تصدير</div>

      <div id="formArea" class="grid" style="display:none">
        <div class="form-grid" id="dynForm"></div>
        <div class="btnbar">
          <button id="btnRefreshTime" title="تحديث التاريخ الآن">تحديث التاريخ الآن</button>
          <button id="btnAdd">إضافة صف</button>
          <button id="btnExport">تصدير Excel</button>
          <button id="btnClear">تفريغ القائمة</button>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <span class="pill">الأعمدة: <span id="hdrCount" class="hl">0</span></span>
            <span class="pill">صفوف مدخلة: <span id="rowCount" class="hl">0</span></span>
            <span class="pill">الورقة: <span id="sheetName" class="hl"></span></span>
          </div>
          <table>
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- مودال معاينة الكاميرا -->
  <div id="cameraModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="modal-card">
      <video id="camPreview" playsinline muted autoplay></video>
      <div class="actions">
        <button id="btnCloseCam">إلغاء</button>
        <div style="display:flex;gap:8px">
          <button id="btnFlipCam" title="تبديل الكاميرا">تبديل الكاميرا</button>
          <button id="btnSnap">التقاط</button>
        </div>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = 'rentform_rows_v3';
const TZ = 'Asia/Baghdad';
const DATE_FIELD_VARIANTS = ['التاريخ','Date','date'];
const LOCATION_FIELD = 'الموقع';
const PHOTO_FIELD = 'الصورة';
const DEFAULT_FILE_NAME = 'فورمة_التاجير_معبأة.xlsx';

function nowBaghdad(){ const now=new Date(); return new Intl.DateTimeFormat('en-CA',{ timeZone:TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false }).format(now).replace(',',''); }

const PREVIEW_HEADERS = [ { title:'التاريخ' }, { title:'اسم المستأجر' }, { title:'المبلغ' }, { title:'عدد الساعات' }, { title:'الموقع' }, { title: PHOTO_FIELD }, { title:'ملاحظات' } ];
let headers=[...PREVIEW_HEADERS]; let rows=[];

const dynForm=document.getElementById('dynForm');
const thead=document.getElementById('thead');
const tbody=document.getElementById('tbody');
const msgOk=document.getElementById('msgOk');
const msgWarn=document.getElementById('msgWarn');
const rowCountEl=document.getElementById('rowCount');
const hdrCountEl=document.getElementById('hdrCount');
const sheetNameEl=document.getElementById('sheetName');
const formArea=document.getElementById('formArea');

// عناصر المودال
const cameraModal = document.getElementById('cameraModal');
const camVideo = document.getElementById('camPreview');
const btnCloseCam = document.getElementById('btnCloseCam');
const btnSnap = document.getElementById('btnSnap');
const btnFlipCam = document.getElementById('btnFlipCam');
let camStream = null; let useFacing = 'environment'; let targetPhotoInput = null;

function ok(m){ msgOk.textContent=m; msgOk.style.display='block'; msgWarn.style.display='none'; setTimeout(()=>{ msgOk.style.display='none'; },2500); }
function warn(m){ msgWarn.textContent=m; msgWarn.style.display='block'; msgOk.style.display='none'; setTimeout(()=>{ msgWarn.style.display='none'; },3500); }

function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }
function loadLocal(){ try{ rows = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ rows=[]; } }

function compressImageToDataURL(file, maxSide=1024, quality=0.8){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > h && w > maxSide) { h = Math.round(h * maxSide / w); w = maxSide; }
        else if (h > w && h > maxSide) { w = Math.round(w * maxSide / h); h = maxSide; }
        else if (w === h && w > maxSide) { w = h = maxSide; }
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const dataURL = canvas.toDataURL('image/jpeg', quality);
        resolve(dataURL);
      };
      img.onerror = reject;
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

async function openCamera(){
  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    throw new Error('يتطلب فتح الكاميرا عبر HTTPS أو localhost');
  }
  camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: useFacing } }, audio:false });
  camVideo.srcObject = camStream; camVideo.play();
  cameraModal.classList.add('show');
}
function closeCamera(){
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  camVideo.srcObject=null; cameraModal.classList.remove('show');
}
btnCloseCam.onclick = ()=>{ closeCamera(); targetPhotoInput=null; };
btnFlipCam.onclick = async ()=>{ useFacing = (useFacing==='environment'?'user':'environment'); if(camStream){ closeCamera(); try{ await openCamera(); }catch(e){ warn('تعذر تبديل الكاميرا'); } } };
btnSnap.onclick = ()=>{
  try{
    const w = camVideo.videoWidth || 1280;
    const h = camVideo.videoHeight || 720;
    const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d'); ctx.drawImage(camVideo,0,0,w,h);
    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
    if(targetPhotoInput){ targetPhotoInput.value = dataURL; ok('تم التقاط الصورة'); }
  }catch(e){ warn('تعذر التقاط الإطار'); }
  finally{ closeCamera(); }
};

function buildUI(){
  dynForm.innerHTML='';
  headers.forEach(h=>{
    const isDate = DATE_FIELD_VARIANTS.includes(h.title);
    const wrap = document.createElement('div');
    wrap.className = 'field';
    const initVal = isDate ? nowBaghdad() : '';

    if(h.title===PHOTO_FIELD){
      wrap.innerHTML = `<label>${h.title}</label>
        <input type="text" data-key="${h.title}" value="" placeholder="التقط صورة" readonly>
        <button class="cam-btn" title="تشغيل الكاميرا" type="button">📸</button>
        <input type="file" accept="image/*" capture="environment" style="display:none">`;
      const camBtn = wrap.querySelector('.cam-btn');
      const fileInput = wrap.querySelector('input[type="file"]');
      camBtn.onclick = async ()=>{
        targetPhotoInput = wrap.querySelector(`[data-key='${PHOTO_FIELD}']`);
        try{ await openCamera(); }
        catch(e){ console.warn('camera error, fallback to file input', e); fileInput.click(); }
      };
      fileInput.onchange = async (e)=>{
        const file=e.target.files&&e.target.files[0]; if(!file) return;
        try{
          const dataURL = await compressImageToDataURL(file, 1280, 0.8);
          const inp = wrap.querySelector(`[data-key='${PHOTO_FIELD}']`);
          if(inp) inp.value = dataURL;
          ok('تم اختيار الصورة');
        }catch(err){ warn('تعذر معالجة الصورة المختارة'); }
      };
    } else {
      wrap.innerHTML = `<label>${h.title}${isDate?' (أوتوماتيكي)':''}</label><input type="text" data-key="${h.title}" value="${initVal}" ${isDate?'readonly disabled':''} placeholder="${h.title}">`;
      if(h.title===LOCATION_FIELD){
        const geoBtn=document.createElement('button');
        geoBtn.className='geo-btn'; geoBtn.textContent='📍'; geoBtn.title='التقاط الإحداثيات عبر GPS';
        geoBtn.onclick=()=>{
          if(!('geolocation' in navigator)) return warn('جهازك لا يدعم تحديد الموقع (Geolocation).');
          if(location.protocol!=='https:' && location.hostname!=='localhost'){ return warn('المتصفحات تمنع الموقع بدون HTTPS.'); }
          ok('جاري التقاط الموقع...');
          navigator.geolocation.getCurrentPosition((pos)=>{
            const {latitude,longitude,accuracy}=pos.coords;
            const field=dynForm.querySelector(`[data-key='${LOCATION_FIELD}']`);
            if(field) field.value=`${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${Math.round(accuracy)}m)`;
            ok('تم التقاط الموقع بنجاح');
          },(err)=>{ warn('تعذر التقاط الإحداثيات: '+err.message); },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
        };
        wrap.appendChild(geoBtn);
      }
    }
    dynForm.appendChild(wrap);
  });
  thead.innerHTML=''; headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h.title; thead.appendChild(th); });
  hdrCountEl.textContent=headers.length;
  const btnRefresh=document.getElementById('btnRefreshTime');
  if(btnRefresh){ btnRefresh.onclick=()=>{ const inp=dynForm.querySelector(`[data-key='التاريخ']`); if(inp){ inp.value=nowBaghdad(); ok('تم تحديث التاريخ.'); } }; }
}

function collect(){ const obj={}; headers.forEach(h=>{ const inp=dynForm.querySelector(`[data-key='${h.title}']`); obj[h.title]=inp?inp.value:''; }); return obj; }
function isEmpty(obj){ return headers.every(h=> (DATE_FIELD_VARIANTS.includes(h.title)?true:!(obj[h.title]||'').trim())); }
function appendPreviewRow(obj){
  const tr=document.createElement('tr');
  headers.forEach(h=>{
    const td=document.createElement('td');
    if(h.title===PHOTO_FIELD && obj[h.title] && obj[h.title].startsWith('data:image')){
      const span=document.createElement('span'); span.className='thumb';
      const img=document.createElement('img'); img.src=obj[h.title];
      span.appendChild(img); td.appendChild(span);
    } else {
      td.textContent=obj[h.title]||'';
    }
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
}
function refreshTable(){ tbody.innerHTML=''; rows.forEach(appendPreviewRow); rowCountEl.textContent=rows.length; }

function onAdd(){ const obj=collect(); if(isEmpty(obj)) return warn('الصف فارغ'); if(!obj['التاريخ']) obj['التاريخ']=nowBaghdad(); rows.push(obj); saveLocal(); refreshTable(); ok('تمت الإضافة'); }
function onClear(){ rows=[]; saveLocal(); refreshTable(); warn('تم التفريغ'); }

// ===== التصدير إلى Excel (مع إدراج الصورة داخل الخلية) =====
function isIOSSafari(){ const ua=navigator.userAgent; const iOS=/iP(hone|od|ad)/.test(ua); const webkit=/WebKit/i.test(ua); const isCriOS=/CriOS/i.test(ua); const isFxiOS=/FxiOS/i.test(ua); return iOS && webkit && !isCriOS && !isFxiOS; }
async function downloadBlob(blob, filename){ if(isIOSSafari()){ const reader=new FileReader(); const url=await new Promise((res,rej)=>{ reader.onerror=rej; reader.onload=()=>res(reader.result); reader.readAsDataURL(blob);}); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); return; } const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500); }

async function onExport(){
  if(rows.length===0){ return warn('أضف صفًا واحدًا على الأقل قبل التصدير.'); }
  try{
    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('البيانات');

    // اكتب العناوين
    headers.forEach((h,i)=>{ ws.getRow(1).getCell(i+1).value=h.title; });
    ws.getRow(1).font = { bold: true };

    // قياسات أعمدة افتراضية
    headers.forEach((h,i)=>{ ws.getColumn(i+1).width = (h.title===PHOTO_FIELD)?20:18; });
    let currentRow = 2;

    for(const r of rows){
      // اكتب النصوص أولاً
      headers.forEach((h,i)=>{
        if(h.title!==PHOTO_FIELD){
          ws.getRow(currentRow).getCell(i+1).value = String(r[h.title] ?? '');
        } else {
          ws.getRow(currentRow).getCell(i+1).value = r[h.title] ? '📷' : '';
        }
      });

      // أضف الصورة إن وجدت
      const dataURL = r[PHOTO_FIELD];
      if(dataURL && dataURL.startsWith('data:image')){
        const imageId = wb.addImage({ base64: dataURL, extension: dataURL.includes('png')?'png':'jpeg' });
        const colIndex = headers.findIndex(h=>h.title===PHOTO_FIELD) + 1;
        // ضع الصورة ضمن حدود خلية الصورة تقريبًا
        ws.addImage(imageId, {
          tl: { col: colIndex-1 + 0.15, row: currentRow-1 + 0.15 },
          ext: { width: 120, height: 90 }
        });
        ws.getRow(currentRow).height = 72; // ارتفاع مناسب للصورة
      }
      ws.getRow(currentRow).commit();
      currentRow++;
    }

    const buf = await wb.xlsx.writeBuffer();
    const blob = new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    await downloadBlob(blob, DEFAULT_FILE_NAME);
    ok('تم التصدير مع تضمين الصور.');
  }catch(e){ console.error(e); warn('حدث خطأ أثناء التصدير — جرّب متصفح حديث وافتح الصفحة عبر HTTPS.'); }
}

window.addEventListener('DOMContentLoaded',()=>{
  buildUI(); loadLocal(); refreshTable(); sheetNameEl.textContent='Ready'; formArea.style.display='';
  document.getElementById('btnAdd').onclick=onAdd;
  document.getElementById('btnClear').onclick=onClear;
  document.getElementById('btnExport').onclick=onExport;

  // اختصارات
  document.addEventListener('keydown',(e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onAdd(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); onExport(); }
  });
});
</script>
</body>
</html>
